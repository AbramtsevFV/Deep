## Description

Детектор интентов. Каждый utterance приходит разбитый на предложения с помощью sentseg, каждое предложение
эмбеддится с помощью Universal sentence encoder (USE, https://arxiv.org/pdf/1803.11175.pdf).
В файле `src/detector.py` лежат различные детекторы.

## Описание детекторов:

- **USESimpleDetector**:  каждое предложение utterance сравнивается по метрике (*cosine similarity*) с предложениями интентов, берется максимум скора по всем предложениям и отсекается по трешхолду, вычисленному заранее.
- **USERegCombinedDetector**: каждое предложение сначала прогоняется через regexp, если же ни один интент не замэтчился - отправляем предложение в **USESimpleDetector**.
- **ClassifierDetector**: (линейный) классификатор, обученный поверх эмбеддингов USE.
- **ClassRegCombinedDetector** (TBD): то же самое что и **USERegCombinedDetector**, только c **ClassifierDetector**.

## TODO:

- Code refactoring

## Метрики

**USERegCombinedDetector**:

| metrics/intents | exit        | repeat      | what\_is\_your\_name | where\_are\_you\_from | what\_can\_you\_do | who\_made\_you | what\_is\_your\_job |
|-----------------|-------------|-------------|----------------------|-----------------------|--------------------|----------------|---------------------|
| precision       | 0.933369776 | 0.819418869 | 0.996363636          | 0.958124098           | 0.851321586        | 0.876727199    | 0.92990404          |
| recall          | 0.617079005 | 0.731826007 | 0.818103175          | 0.87984127            | 0.72               | 0.877472177    | 0.905040404         |
| f1              | 0.735439153 | 0.767964591 | 0.893786162          | 0.909311858           | 0.670418219        | 0.874162102    | 0.912530126         |

**Linear classifier**

| metrics/intent | cant\_do            | doing\_well         | dont\_understand    | exit                | lets\_chat\_about   | no                  | opinion\_request    | repeat              | stupid              | tell\_me\_a\_story  | tell\_me\_more      | topic\_switching    | weather\_forecast\_intent | what\_can\_you\_do  | what\_is\_your\_job | what\_is\_your\_name | what\_time           | where\_are\_you\_from | who\_made\_you      | yes                 |
|----------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------------|---------------------|---------------------|----------------------|----------------------|-----------------------|---------------------|---------------------|
| precision      | 0\.996370827930234  | 1\.0                | 0\.9963139895369914 | 0\.976848369399141  | 0\.9980131016611729 | 0\.98259640923863   | 0\.9967476604124078 | 1\.0                | 0\.9915204483975734 | 1\.0                | 1\.0                | 0\.9938837358914336 | 0\.9981449057007502       | 0\.9457619876521479 | 0\.9834451345755694 | 0\.9954545454545455  | 0\.4                 | 0\.9979233801034255   | 0\.9842851620862507 | 0\.9989473684210527 |
| recall         | 0\.9789907024298004 | 0\.8418686609758457 | 0\.9612128273947134 | 0\.8852047711902987 | 0\.7815816203758551 | 0\.7292528054953611 | 0\.9930852795250376 | 0\.9606103041529309 | 0\.9339179376498782 | 0\.9954179988769324 | 0\.7009442054333695 | 0\.975010632291602  | 0\.9809229005599981       | 0\.680864462197054  | 0\.7706581286360698 | 0\.7832070707070706  | 0\.10833333333333332 | 0\.9268384477169841   | 0\.9664957811945529 | 0\.5560519627197736 |
| f1             | 0\.9875945058294399 | 0\.9118411709630541 | 0\.9783849317626867 | 0\.9287165438688353 | 0\.8761461561467232 | 0\.8350542929671784 | 0\.9949123130751806 | 0\.9797954964671032 | 0\.9617408474913504 | 0\.9976824122078183 | 0\.819892689538017  | 0\.9843307745941875 | 0\.9894513879675697       | 0\.7842091598255596 | 0\.8606044927745723 | 0\.8700951447994909  | 0\.16369047619047622 | 0\.960758547879826    | 0\.9746511535963178 | 0\.711350597533756  |

**MLP**

| metrics/intent | cant\_do | doing\_well         | dont\_understand    | exit                | lets\_chat\_about   | no                  | opinion\_request    | repeat              | stupid              | tell\_me\_a\_story  | tell\_me\_more      | topic\_switching    | weather\_forecast\_intent | what\_can\_you\_do  | what\_is\_your\_job | what\_is\_your\_name | what\_time          | where\_are\_you\_from | who\_made\_you      | yes                 |
|----------------|----------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------------|---------------------|---------------------|----------------------|---------------------|-----------------------|---------------------|---------------------|
| precision      | 1\.0     | 0\.9506862924519208 | 0\.992077990879744  | 0\.9959211282809097 | 1\.0                | 0\.9984601843869975 | 0\.9942399419139271 | 0\.9879208871274475 | 0\.988900695904789  | 0\.9812465217291091 | 0\.9954691014457939 | 0\.9965689877987499 | 0\.9936999152594238       | 0\.9594597069597068 | 0\.9607142857142857 | 0\.9969285880301101  | 0\.9737811844941715 | 0\.9521993679799691   | 0\.9557441397611676 | 0\.9792891422361454 |
| recall         | 1\.0     | 0\.9671428571428571 | 0\.9858552631578947 | 0\.979813664596273  | 0\.9904761904761902 | 0\.9974325147148365 | 0\.9807142857142856 | 0\.9785249457700651 | 0\.9798955613577023 | 0\.9664948453608245 | 0\.9916083916083916 | 0\.9969990548204158 | 0\.9941818181818182       | 0\.9208333333333334 | 0\.95               | 0\.9904434250764526  | 0\.9412162162162161 | 0\.9473684210526315   | 0\.8150000000000001 | 0\.9406976744186046 |
| f1             | 1\.0     | 0\.9577265424310811 | 0\.9889227300705796 | 0\.9877359215487399 | 0\.995166029973553  | 0\.9979457084332027 | 0\.987297506088274  | 0\.9831837488331315 | 0\.9843721611512131 | 0\.9737852416437004 | 0\.9935078119092104 | 0\.9967831428096062 | 0\.9939328295281422       | 0\.9372711998146779 | 0\.9502525252525252 | 0\.9936699892976396  | 0\.9568029221278561 | 0\.9483361977063234   | 0\.8761066603926982 | 0\.9589277060833948 |


## Getting started

Чтобы добавить интент, нужно:
 1. Вписать в `<intent_data_path>/intent_phrases.json` имя вашего интента, фразы/регекспы фраз, по которым будет идти матчинг, допустимые в этом случае знаки пунктуации, а также min_precision - минимально приемлимый precision для подбора трешхолда.
 2. Затем выполнить `python3 create_data_and_train_model.py`, чтобы обучить модель. Трешхолды будут сохранены в `intent_data.json`

Пример запуска внутри докера:
 ```
  python3 /data/create_data_and_train_model.py
 ```
