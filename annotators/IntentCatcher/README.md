## Description

Детектор интентов. Каждый utterance приходит разбитый на предложения с помощью sentseg, каждое предложение
эмбеддится с помощью Universal sentence encoder (USE, https://arxiv.org/pdf/1803.11175.pdf).
В файле `src/detector.py` лежат различные детекторы.

## Описание детекторов:

- **USESimpleDetector**:  каждое предложение utterance сравнивается по метрике (*cosine similarity*) с предложениями интентов, берется максимум скора по всем предложениям и отсекается по трешхолду, вычисленному заранее.
- **USERegCombinedDetector**: каждое предложение сначала прогоняется через regexp, если же ни один интент не замэтчился - отправляем предложение в **USESimpleDetector**.
- **ClassifierDetector**: (линейный) классификатор, обученный поверх эмбеддингов USE.
- **ClassRegCombinedDetector** (TBD): то же самое что и **USERegCombinedDetector**, только c **ClassifierDetector**.

## TODO:

- Code refactoring

## Метрики

**USERegCombinedDetector**:

| metrics/intents | exit        | repeat      | what\_is\_your\_name | where\_are\_you\_from | what\_can\_you\_do | who\_made\_you | what\_is\_your\_job |
|-----------------|-------------|-------------|----------------------|-----------------------|--------------------|----------------|---------------------|
| precision       | 0.933369776 | 0.819418869 | 0.996363636          | 0.958124098           | 0.851321586        | 0.876727199    | 0.92990404          |
| recall          | 0.617079005 | 0.731826007 | 0.818103175          | 0.87984127            | 0.72               | 0.877472177    | 0.905040404         |
| f1              | 0.735439153 | 0.767964591 | 0.893786162          | 0.909311858           | 0.670418219        | 0.874162102    | 0.912530126         |

**Linear classifier**

| metrics/intent | cant\_do            | doing\_well         | dont\_understand    | exit                | no                  | opinion\_request    | repeat              | stupid              | tell\_me\_a\_story  | tell\_me\_more      | topic\_switching    | weather\_forecast\_intent | what\_can\_you\_do  | what\_is\_your\_job | what\_is\_your\_name | what\_time           | where\_are\_you\_from | who\_made\_you      | yes                 |
|----------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------------|---------------------|---------------------|----------------------|----------------------|-----------------------|---------------------|---------------------|
| precision      | 0\.9982256893223245 | 0\.9988636363636363 | 0\.997139962975778  | 0\.9802773660591144 | 0\.9849255530803781 | 0\.998558384023711  | 1\.0                | 0\.9908647886699677 | 1\.0                | 1\.0                | 0\.999438370642376  | 0\.9998350898725057       | 0\.9451090286525069 | 0\.9863704177323103 | 0\.9566376811594204  | 0\.6375              | 1\.0                  | 0\.9882038930562205 | 1\.0                |
| recall         | 0\.988799006756626  | 0\.826280745095425  | 0\.9550368367905427 | 0\.9014087726032953 | 0\.7800048219551325 | 0\.9947050778251405 | 0\.9542742489604347 | 0\.9351000741045612 | 0\.9973297714532418 | 0\.745342522974102  | 0\.9705858574187912 | 0\.9802952976088918       | 0\.6136555940248931 | 0\.7289464824391296 | 0\.8396027583527582  | 0\.19095238095238096 | 0\.9032740200572889   | 0\.976598064104316  | 0\.5428237370470723 |
| f1             | 0\.9934853363290982 | 0\.9021113669025448 | 0\.9755578175621047 | 0\.9391433460653129 | 0\.868171188833467  | 0\.9966275706275216 | 0\.9764510476949793 | 0\.962096319958102  | 0\.9986549845794356 | 0\.8504801664223705 | 0\.9847654530624332 | 0\.9899641692627691       | 0\.7341523746957505 | 0\.8303520511919199 | 0\.8904308207961223  | 0\.27965873015873016 | 0\.9487587821613745   | 0\.982131052763558  | 0\.7019927712314952 |



## Getting started

Чтобы добавить интент, нужно:
 1. Вписать в `<intent_data_path>/intent_phrases.json` имя вашего интента, фразы/регекспы фраз, по которым будет идти матчинг, допустимые в этом случае знаки пунктуации, а также min_precision - минимально приемлимый precision для подбора трешхолда.
 2. Затем выполнить `python3 create_data.py <intent_data_path>/intent_phrases.json -p`, чтобы добавить эмбеддинги фраз, сами фразы (`-p` key) трешхолды и параметры для вычисления *confidence* (`-t` key). Они будут лежать в `<intent_data_path>/intent_data.json`
 3. Чтобы обучить **ClassifierDetector** на новых фразах (новых интентах), выполнить `python3 train_model.py --data_path <intent_data_path>/intent_data_train.json`.
 4. Затем следует сделать дамп `intent_data.json` на `share` под версией `intent_data_v<n>.json`, где номер версии `n` указан в Dockerfile

Пример запуска внутри докера:
 ```
  python3 create_data.py /data/classifier_data/intent_phrases.json -p
  python /data/classifier_data/train_model.py --data_path /data/classifier_data/intent_data_train.json --model_path /data/classifier_data/models/linear_classifier.h5
 ```
